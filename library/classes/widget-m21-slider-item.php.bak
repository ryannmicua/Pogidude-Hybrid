<?php
/* LOAD THICKBOX and MEDIA-UPLOAD SCRIPT */
/**
 * The M21 Slider Item Widget
 *
 * @package Mobility21_Library
 * @subpackage Classes
 * @author Ryann Micua
 * @link http://www.pogidude.com
 */

/**
 * The M21 Slider Item Widget Class
 *
 * @since 0.1
 * @depends Tim Thumb Script
 * @link http://code.google.com/p/timthumb/
 * @optional use with Hybrid-core framework to use automatic prefix and textdomain.
 * @link http://themehybrid.com/themes/hybrid/widgets
 */

class M21_Slider_Item_Widget extends WP_Widget{

	/**
	 * Prefix for the widget.
	 * @since 0.1
	 */
	var $prefix;

	/**
	 * Textdomain for the widget.
	 * @since 0.1
	 */
	var $textdomain;
	
	/**
	 * Set up the widget's unique name, ID, class, description, and other options.
	 * @since 0.1
	 */
	function M21_Slider_Item_Widget(){
	
		/* Check if Hybrid-core framework is active */
		if( class_exists( 'Hybrid' ) ){
			/* Set the widget prefix */
			$this->prefix = hybrid_get_prefix();
			
			/* Set the widget textdomain. */
			$this->textdomain = hybrid_get_textdomain();
		} else {
			$this->prefix = 'mobility21';
			$this->textdomain = 'mobility21';
		}
		
		$widget_options = array(
						'classname' => 'm21-slider-item',
						'description' => esc_html__( 'Adds a slider item to Mobility 21 site frontpage slider.', $this->textdomain ) 
					);
		
		$control_options = array(
						'height' => '300',
						'width' => '700',
						'id_base' => "{$this->prefix}-m21-slider-item", esc_attr__( 'M21 Slider Item', $this->textdomain )
					);
		
		$this->WP_Widget( "{$this->prefix}-m21-slider-item", esc_attr__( 'Mobility Slider Item', $this->textdomain ), $widget_options, $control_options );
	}
	
	function form( $instance ){
	
		$defaults = array(
						'div_class' => 'm21-single-ad-wrap'
					);
		
		$instance = wp_parse_args( (array) $instance, $defaults );
		
		//following variables needed for Tim Thumb script
		$thumb_width=500; //width
		$thumb_height=140; //height without
		$zoom_crop=0; //0 or 1
		$quality = 75; //default 75 max 100
		
	?>		
		<p>
			<label for="<?php echo $this->get_field_id('title'); ?>" ><?php _e( 'Title : ', $this->textdomain ); ?></label>
			<input type="text" name="<?php echo $this->get_field_name('title'); ?>" id="<?php echo $this->get_field_id('title'); ?>" value="<?php echo esc_attr( $instance['title'] ); ?>" />
			<br /><em><small>This won't be displayed. Used only for identifying this widget in the widget area.</small></em>
		</p>
		
		<?php if( !empty( $instance['image_url'] ) ) : ?>
		<p>
			<h3 style="margin-bottom: 0;"><?php _e('Image Preview Thumbnail', $this->textdomain ); ?></h3>
			<img src="<?php echo MOBILITY_SCRIPTS_URI . '/thumb.php?src=' . $instance['image_url'] . '&w=' . $thumb_width . '&h=' . $thumb_height . '&zc=' . $zoom_crop; ?>" />
		</p>
		<?php endif; ?>

		<div class="hybrid-widget-controls columns-2" style="width:400px;" >
			<h3 style="margin-bottom: 0;">Advanced Settings</h3>
			<p><em><small>Use the settings here to create additional html content.</small></em></p>

			<p>
				<label for="<?php echo $this->get_field_id('html_code'); ?>" ><?php _e('HTML Content: ', $this->textdomain ); ?></label>
				
				<textarea class="widefat code" name="<?php echo $this->get_field_name('html_code'); ?>" id="<?php echo $this->get_field_id('html_code'); ?>" cols="30" rows="12" ><?php echo $instance['html_code']; ?></textarea>
				<br /><em><small>Common html elements are explained below.</small></em>
			</p>
			
			<p>
				<h3 style="margin: 0;">Generate HTML Element</h3>
				<select id="slider-html-elements" style="min-width: 200px;">
					<option value="">Choose an html element</option>
					<option value="button">Button</option>
					<option value="text">Text</option>
					<option value="image">Image</option>
				</select>
			</p>
			
			<div id="slider-generated-display" style="margin-top: 3px;">
				<p id="slider-element-options-button" style="display: none;">
					<label>Button Text</label>
					<input type="text" class="slider-element-linktext widefat" value="" />
					<label>Button URL <em>(site url to load when button is clicked)</em></label>
					<textarea class="slider-element-linkurl widefat code" rows="2"></textarea>
				</p>
				<p id="slider-element-options-text" style="display: none;">
					<label>Type your text below <em>(No html):</em></label>
					<textarea class="slider-element-text widefat code" rows="3"></textarea>
				</p>
				<p id="slider-element-options-image" style="display: none;">
					<label>Image URL</label> <small>(<a href="<?php echo admin_url('/media-upload.php?type=image&amp;TB_iframe=1' ); ?>" class="thickbox">Open Image Browser</a>)</small>
					<textarea class="slider-element-imageurl widefat code"></textarea>
				</p>
			</div>
			<div id="slider-element-position" style="display: none">
				<p>
					<label>Distance from left edge of the slider area:</label>
					<input type="text" id="slider-element-posx" value="380px" size="4" />
					<br />
					<label>Distance from top edge of the slider area:</label>
					<input type="text" id="slider-element-posy" value="170px" size="4" />
				</p>
			</div>
			
			<div id="slider-element-result">
			</div>
			<em id="slider-element-result-explain"><small>Copy and paste the html code above into the HTML Content input field. You may modify the element attributes if you know what you are doing.</small></em>
			
			
		</div>
		
		<div class="hybrid-widget-controls columns-2 column-last" style="width: 280px;">
	
			<h3 style="margin-bottom: 0;">Basic Settings</h3>
			<p><em><small>Add a slider image and optionally make it clickable by providing a link url.</small></em></p>
	
			<p>
				<label for="<?php echo $this->get_field_id('image_url'); ?>" ><?php _e('Background Image URL: ', $this->textdomain ); ?></label>
				<textarea class="widefat code" name="<?php echo $this->get_field_name('image_url'); ?>" id="<?php echo $this->get_field_id('image_url'); ?>" cols="32" rows="3" ><?php echo $instance['image_url']; ?></textarea>
				<br />
				<em><small>Maximum viewing area is 940px wide and 320px high. Image parts extending past the maximum viewing area will be cropped out. Use the <strong>width</strong> and <strong>height</strong> settings below to resize the image. Example: http://example.com/image.jpg <a href="<?php echo admin_url('/media-upload.php?type=image&amp;TB_iframe=1' ); ?>" class="thickbox">Image Browser</a></small></em>
			</p>
	
			<p>
				<label for="<?php echo $this->get_field_id('image_width'); ?>" ><?php _e('Width: ', $this->textdomain ); ?></label>
				<input type="text" name="<?php echo $this->get_field_name('image_width'); ?>" id="<?php echo $this->get_field_id('image_width'); ?>" value="<?php echo $instance['image_width']; ?>" size="4" />
				<label for="<?php echo $this->get_field_id('image_height'); ?>" ><?php _e('Height: ', $this->textdomain ); ?></label>
				<input type="text" name="<?php echo $this->get_field_name('image_height'); ?>" id="<?php echo $this->get_field_id('image_height'); ?>" value="<?php echo $instance['image_height']; ?>" size="4" />
				<br />
				<em><small>Values here are applied only when they are provided. If not provided, then the actual dimensions of the background image will be used. <strong>Example: 250.</strong></small></em>
			</p>
	
			<p>
				<label for="<?php echo $this->get_field_id('link_url'); ?>" ><?php _e('Link URL: ', $this->textdomain ); ?></label>
				<textarea class="widefat code" name="<?php echo $this->get_field_name('link_url'); ?>" id="<?php echo $this->get_field_id('link_url'); ?>" cols="32" rows="3" ><?php echo $instance['link_url']; ?></textarea>
				<br /><em><small>Setting this option will make the whole slider area clickable. Provide the URL here. <strong>Example: http://example-site.com</strong>
				<br />
				<br />This setting is ignored when <strong>HTML Content</strong> is added in the <strong>Advanced Settings</strong>.</small></em>
			</p>
			
		</div>

		
		<div style="clear:both;">&nbsp;</div>

	<?php
	}
	
	function update( $new_instance, $old_instance ){
	
		$instance = $old_instance;
		
	//	$instance = $new_instance;
		
		$instance['title'] = sanitize_title( $new_instance['title'] );
		$instance['image_url'] = $new_instance['image_url'];
		$instance['image_height'] = intval( $new_instance['image_height'] );
		$instance['image_width'] = intval( $new_instance['image_width'] );
		$instance['link_url'] = $new_instance['link_url'];
		$instance['html_code'] = $new_instance['html_code'];
		
		return $instance;
	}
	
	function widget( $args, $instance ){
		extract( $args );
		
		/* if the title was input by the user, get it */
		//$title =  !empty( $instance['title'] ) ? $instance['title'] : '';
		
		/* URL to the image used */
		$image_url = $instance['image_url'];
		
		/* Height of the image */
		$image_height = ( !empty( $instance['image_height'] ) ) ? 'height="' . $instance['image_height'] . '"' : '';
		
		/* Width of the image */
		$image_width = (  $instance['image_width'] ) ? 'width="' . $instance['image_width'] . '"' : '';
		
		/* Additional HTML Content */
		$html_content = ( $instance['html_code'] ) ? $instance['html_code'] : '';
		
		/* href URL */
		$link_url = ( !empty( $instance['link_url'] ) ) ? $instance['link_url'] : '';
		
		/* div class wrapping the image button */
	//	$div_class = ( empty( $instance['div_class'] ) ) ? 'image-button-wrap' : $instance['div_class'] ;
		
	//	$out = '<div class="' . $div_class . '">';
		
		//create the background image element
		$out .= '<img src="' . $image_url . '" ' . $image_height . '" ' . $image_width . '" />';		
		
		if( !empty( $link_url ) ){
			$out = '<a href="' . $link_url . '" class="slider-link">' . $out . '</a>';
		}
		
		if( !empty( $html_content ) ){
			//wrap the html content inside a div
			//add additional html content
			$out .= '<div class="slider-html-content">' . $html_content . '</div>';
		}

		
		echo $before_widget;
	//	echo $before_title . $title . $after_title;
		echo $out;
		echo $after_widget;
	}
}

?>
