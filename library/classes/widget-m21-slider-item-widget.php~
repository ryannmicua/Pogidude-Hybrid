<?php
/**
 * The M21 Slider Item Widget
 *
 * @package Mobility21_Library
 * @subpackage Classes
 * @author Ryann Micua
 * @link http://www.pogidude.com
 */

/**
 * The M21 Slider Item Widget Class
 *
 * @since 0.1
 * @depends Tim Thumb Script
 * @link http://code.google.com/p/timthumb/
 * @optional use with Hybrid-core framework to use automatic prefix and textdomain.
 * @link http://themehybrid.com/themes/hybrid/widgets
 */

class M21_Slider_Item_Widget extends WP_Widget{

	/**
	 * Prefix for the widget.
	 * @since 0.1
	 */
	var $prefix;

	/**
	 * Textdomain for the widget.
	 * @since 0.1
	 */
	var $textdomain;
	
	/**
	 * Set up the widget's unique name, ID, class, description, and other options.
	 * @since 0.1
	 */
	function M21_Single_Ad_Widget(){
	
		/* Check if Hybrid-core framework is active */
		if( class_exists( 'Hybrid' ) ){
			/* Set the widget prefix */
			$this->prefix = hybrid_get_prefix();
			
			/* Set the widget textdomain. */
			$this->textdomain = hybrid_get_textdomain();
		} else {
			$this->prefix = 'mobility21';
			$this->textdomain = 'mobility21';
		}
		
		$widget_options = array(
						'classname' => 'm21-slider-item',
						'description' => esc_html__( 'Adds a slider item to Mobility 21 site frontpage slider.', $this->textdomain ) 
					);
		
		$control_options = array(
						'height' => '300',
						'width' => '250',
						'id_base' => "{$this->prefix}-m21-slider-item", esc_attr__( 'M21 Slider Item', $this->textdomain )
					);
		
		$this->WP_Widget( "{$this->prefix}-m21-slider-item", esc_attr__( 'Mobility 21 Slider Item', $this->textdomain ), $widget_options, $control_options );
	}
	
	function form( $instance ){
	
		$defaults = array(
						'div_class' => 'm21-single-ad-wrap'
					);
		
		$instance = wp_parse_args( (array) $instance, $defaults );
		
	?>
		<p>
			<label for="<?php echo $this->get_field_id('title'); ?>" ><?php _e( 'Title : ', $this->textdomain ); ?></label>
			<input type="text" name="<?php echo $this->get_field_name('title'); ?>" id="<?php echo $this->get_field_id('title'); ?>" value="<?php echo esc_attr( $instance['title'] ); ?>" />
			<br /><em><small>Won't be displayed. Used for identifying this widget in the widget area.</small></em>
		</p>

		<p>
			<label for="<?php echo $this->get_field_id('image_url'); ?>" ><?php _e('Image URL: ', $this->textdomain ); ?></label>
			<textarea name="<?php echo $this->get_field_name('image_url'); ?>" id="<?php echo $this->get_field_id('image_url'); ?>" cols="23" rows="4" ><?php echo $instance['image_url']; ?></textarea>
		</p>
		<p>
			<label for="<?php echo $this->get_field_id('image_alt_text'); ?>" ><?php _e('Alt Text ', $this->textdomain ); ?><em><small>(optional - for seo purposes)</small></em> :</label>
			<input type="text" name="<?php echo $this->get_field_name('image_alt_text'); ?>" id="<?php echo $this->get_field_id('image_alt_text'); ?>" value="<?php echo $instance['image_alt_text']; ?>" size="25" />
		</p>

		<p>
			<label for="<?php echo $this->get_field_id('image_width'); ?>" ><?php _e('Width: ', $this->textdomain ); ?></label>
			<input type="text" name="<?php echo $this->get_field_name('image_width'); ?>" id="<?php echo $this->get_field_id('image_width'); ?>" value="<?php echo $instance['image_width']; ?>" size="2" />
			<label for="<?php echo $this->get_field_id('image_height'); ?>" ><?php _e('Height: ', $this->textdomain ); ?></label>
			<input type="text" name="<?php echo $this->get_field_name('image_height'); ?>" id="<?php echo $this->get_field_id('image_height'); ?>" value="<?php echo $instance['image_height']; ?>" size="2" />
			<br />
			<em><small>Tip: Set width only to set height automatically.</small></em>
		</p>

		<?php if( !empty( $instance['image_url'] ) ) : ?>
		<p>
			<label><?php _e('Image Preview Thumbnail', $this->textdomain ); ?></label>
			<img src="<?php echo MOBILITY_SCRIPTS_URI . '/thumb.php?src=' . $instance['image_url'] . '&w=' . $thumb_width . '&h=' . $thumb_height . '&zc=' . $zoom_crop; ?>" width="<?php echo $thumb_width; ?>" height="<?php echo $thumb_height; ?>" />
		</p>
		<?php endif; ?>

		<p>
			<label for="<?php echo $this->get_field_id('link_url'); ?>" ><?php _e('Link URL: ', $this->textdomain ); ?></label>
			<textarea name="<?php echo $this->get_field_name('link_url'); ?>" id="<?php echo $this->get_field_id('link_url'); ?>" cols="23" rows="4" ><?php echo $instance['link_url']; ?></textarea>
		</p>

		<?php /*
		<p>
			<label for="<?php echo $this->get_field_id('link_text'); ?>" ><?php _e('Link Text ', $this->textdomain ); ?><em><small>(optional - for seo purposes)</small></em> :</label>
			<input type="text" name="<?php echo $this->get_field_name('link_text'); ?>" id="<?php echo $this->get_field_id('link_text'); ?>" value="<?php echo $instance['link_text']; ?>" size="25" />
		</p>
		*/ ?>
		
		<p>
			<label for="<?php echo $this->get_field_id('link_title'); ?>" ><?php _e('Link Title: ', $this->textdomain ); ?><em><small>(optional - for seo purposes)</small></em> :</label>
			<input type="text" name="<?php echo $this->get_field_name('link_title'); ?>" id="<?php echo $this->get_field_id('link_title'); ?>" value="<?php echo $instance['link_title']; ?>" size="25" />
		</p>
		
		<p>
			<label for="<?php echo $this->get_field_id('div_class'); ?>" ><?php _e('Div Class ', $this->textdomain ); ?><em><small>(default: image-button-wrap)</small></em> :</label>
			<input type="text" name="<?php echo $this->get_field_name('div_class'); ?>" id="<?php echo $this->get_field_id('div_class'); ?>" value="<?php echo $instance['div_class']; ?>" size="25" />
		</p>



	<?php
	}
	
	function update( $new_instance, $old_instance ){
	
		//$instance = $old_instance;
		
		//$instance = $new_instance;
		
		$instance['title'] = sanitize_title( $new_instance['title'] );
		
		$instance['m21_ad_id'] = intval( $new_instance['m21_ad_id'] );
		
		$instance['m21_ad_error'] = '';
		
		if( empty( $instance['m21_ad_id'] ) ){
			$instance['m21_ad_error'] = 'Please select an ad from the dropdown menu.';
			$instance['m21_ad_show_details'] = false;
			return $instance;
		}
		
		$instance['m21_ad_show_details'] = true;
		
		return $instance;
		
		//get Post details
		$ad_id= $instance['m21_ad_id'];

		//get ad post meta		
		$instance['m21_ad_account_name'] = strip_tags( get_post_meta( $ad_id, 'adAccountName', true ) );
		$instance['m21_ad_format'] = strip_tags( get_post_meta( $ad_id, 'adFormat', true ) );
		$instance['m21_ad_linkurl'] = esc_url( get_post_meta( $ad_id, 'adLinkUrl', true ) );
		$instance['m21_ad_imageurl'] = esc_url( get_post_meta( $ad_id, 'adImageUrl', true ) );
		
		//get ad format details
		$ad_format = mobility21_get_ad_format( $instance['m21_ad_format'] );
		$instance['m21_ad_width'] = intval( $ad_format['width'] );
		$instance['m21_ad_height'] = intval( $ad_format['height'] );
		
		return $instance;
	}
	
	function widget( $args, $instance ){
		extract( $args );
		
		$ad_id = $instance['m21_ad_id'];
		
		/* if the title was entered by the user, get it */
		$title =  !empty( $instance['title'] ) ? $instance['title'] : '';
		
		//Get company name
		$m21_ad_account_name = strip_tags( get_post_meta( $ad_id, 'adAccountName', true ) );
		
		//get link url
		$m21_ad_linkurl = esc_url( get_post_meta( $ad_id, 'adLinkUrl', true ) );
		
		//get ad format
		$m21_ad_format_id = strip_tags( get_post_meta( $ad_id, 'adFormat', true ) );
		
		//get ad format dimensions
		$ad_format = mobility21_get_ad_format( $m21_ad_format_id );
		$m21_ad_width = intval( $ad_format['width'] );
		$m21_ad_height = intval( $ad_format['height'] );
		
		/* URL to the image used */
		$m21_ad_imageurl = esc_url( get_post_meta( $ad_id, 'adImageUrl', true ) );
		
		/* Height of the image */
		$image_height = ( !empty( $m21_ad_width ) ) ? 'height="' . $m21_ad_height . '"' : '';
		
		/* Width of the image */
		$image_width = (  !empty($m21_ad_width) ) ? 'width="' . $m21_ad_width . '"' : '';
		
		/* href URL */
		$link_url = ( !empty( $m21_ad_linkurl ) ) ? $m21_ad_linkurl : '';
		
		/* Link text */
		$link_text = ( !empty( $m21_ad_account_name ) ) ? $$m21_ad_account_name : '';
		
		/* Link title */
		$link_title = ( !empty( $m21_ad_account_name ) ) ? 'title="' . $m21_ad_account_name . '"' : '';
		
		/* div class wrapping the image button */
		$div_class = ( empty( $instance['div_class'] ) ) ? 'image-button-wrap' : $instance['div_class'] ;
		
		$out = '<div class="m21-ad-wrap m21-single-ad">';
		
		if( !empty( $link_url ) ){
			$out .= '<a href="' . $link_url . '" ' . $link_title . ' >';
		}
		
		$out .= '<img src="' . $m21_ad_imageurl . '" ' . $image_height . '" ' . $image_width . '" ' . $image_alt_text . ' />';
		
		if( !empty( $link_url ) ){
			$out .= '</a>';
		}
		
		/* close the div class */
		$out .= '</div>';
		
		echo $before_widget;
		echo $before_title . $title . $after_title;
		echo $out;
		echo $after_widget;
		
	}
}

?>
